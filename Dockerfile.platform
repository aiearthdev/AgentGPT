FROM python:3.11-slim-buster as prod

WORKDIR /app

ARG PORT
ENV PORT=$PORT
ARG REWORKD_PLATFORM_DATABASE_HOST
ENV REWORKD_PLATFORM_DATABASE_HOST=${REWORKD_PLATFORM_DATABASE_HOST}
ARG REWORKD_PLATFORM_DATABASE_PORT
ENV REWORKD_PLATFORM_DATABASE_PORT=${REWORKD_PLATFORM_DATABASE_PORT}
ARG REWORKD_PLATFORM_DATABASE_USER
ENV REWORKD_PLATFORM_DATABASE_USER=${REWORKD_PLATFORM_DATABASE_USER}
ARG REWORKD_PLATFORM_DATABASE_PASSWORD
ENV REWORKD_PLATFORM_DATABASE_PASSWORD=${REWORKD_PLATFORM_DATABASE_PASSWORD}
ARG REWORKD_PLATFORM_DATABASE_NAME
ENV REWORKD_PLATFORM_DATABASE_NAME=${REWORKD_PLATFORM_DATABASE_NAME}
ARG REWORKD_PLATFORM_DATABASE_URL
ENV REWORKD_PLATFORM_DATABASE_URL=${REWORKD_PLATFORM_DATABASE_URL}

ARG REWORKD_PLATFORM_OPENAI_API_BASE
ENV REWORKD_PLATFORM_OPENAI_API_BASE=${REWORKD_PLATFORM_OPENAI_API_BASE}
ARG REWORKD_PLATFORM_OPENAI_API_KEY
ENV REWORKD_PLATFORM_OPENAI_API_KEY=${REWORKD_PLATFORM_OPENAI_API_KEY}
ARG REWORKD_PLATFORM_REPLICATE_API_KEY
ENV REWORKD_PLATFORM_REPLICATE_API_KEY=${REWORKD_PLATFORM_REPLICATE_API_KEY}
ARG REWORKD_PLATFORM_SID_CLIENT_ID
ENV REWORKD_PLATFORM_SID_CLIENT_ID=${REWORKD_PLATFORM_SID_CLIENT_ID}
ARG REWORKD_PLATFORM_SID_CLIENT_SECRET
ENV REWORKD_PLATFORM_SID_CLIENT_SECRET=${REWORKD_PLATFORM_SID_CLIENT_SECRET}

ARG REWORKD_PLATFORM_RELOAD
ENV REWORKD_PLATFORM_RELOAD=${REWORKD_PLATFORM_RELOAD}
ARG REWORKD_PLATFORM_MAX_LOOPS
ENV REWORKD_PLATFORM_MAX_LOOPS=${REWORKD_PLATFORM_MAX_LOOPS}
ARG REWORKD_PLATFORM_FF_MOCK_MODE_ENABLED
ENV REWORKD_PLATFORM_FF_MOCK_MODE_ENABLED=${REWORKD_PLATFORM_FF_MOCK_MODE_ENABLED}
ARG REWORKD_PLATFORM_ENVIRONMENT
ENV REWORKD_PLATFORM_ENVIRONMENT=${REWORKD_PLATFORM_ENVIRONMENT}
ARG REWORKD_PLATFORM_FRONTEND_URL
ENV REWORKD_PLATFORM_FRONTEND_URL=${REWORKD_PLATFORM_FRONTEND_URL}
ARG REWORKD_PLATFORM_SID_REDIRECT_URI
ENV REWORKD_PLATFORM_SID_REDIRECT_URI=${REWORKD_PLATFORM_SID_REDIRECT_URI}

RUN apt-get update && apt-get install -y \
    default-libmysqlclient-dev \
    gcc \
    pkg-config \
    openjdk-11-jdk \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

RUN pip install poetry==1.4.2

# Configuring poetry
RUN poetry config virtualenvs.create false

# Copying requirements of a project
COPY ./platform/pyproject.toml .

# Installing requirements
RUN poetry install --only main

# Removing gcc
RUN apt-get purge -y \
    g++ \
    gcc \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

# Copying actual application
COPY ./platform .

# Writing all environment variables into a .env file
RUN echo "REWORKD_PLATFORM_DATABASE_HOST=$REWORKD_PLATFORM_DATABASE_HOST" >> .env && \
    echo "REWORKD_PLATFORM_DATABASE_PORT=$REWORKD_PLATFORM_DATABASE_PORT" >> .env && \
    echo "REWORKD_PLATFORM_DATABASE_USER=$REWORKD_PLATFORM_DATABASE_USER" >> .env && \
    echo "REWORKD_PLATFORM_DATABASE_PASSWORD=$REWORKD_PLATFORM_DATABASE_PASSWORD" >> .env && \
    echo "REWORKD_PLATFORM_DATABASE_NAME=$REWORKD_PLATFORM_DATABASE_NAME" >> .env && \
    echo "REWORKD_PLATFORM_DATABASE_URL=$REWORKD_PLATFORM_DATABASE_URL" >> .env && \
    echo "REWORKD_PLATFORM_OPENAI_API_BASE=$REWORKD_PLATFORM_OPENAI_API_BASE" >> .env && \
    echo "REWORKD_PLATFORM_OPENAI_API_KEY=$REWORKD_PLATFORM_OPENAI_API_KEY" >> .env && \
    echo "REWORKD_PLATFORM_REPLICATE_API_KEY=$REWORKD_PLATFORM_REPLICATE_API_KEY" >> .env && \
    echo "REWORKD_PLATFORM_SID_CLIENT_ID=$REWORKD_PLATFORM_SID_CLIENT_ID" >> .env && \
    echo "REWORKD_PLATFORM_SID_CLIENT_SECRET=$REWORKD_PLATFORM_SID_CLIENT_SECRET" >> .env && \
    echo "REWORKD_PLATFORM_RELOAD=$REWORKD_PLATFORM_RELOAD" >> .env && \
    echo "REWORKD_PLATFORM_MAX_LOOPS=$REWORKD_PLATFORM_MAX_LOOPS" >> .env && \
    echo "REWORKD_PLATFORM_FF_MOCK_MODE_ENABLED=$REWORKD_PLATFORM_FF_MOCK_MODE_ENABLED" >> .env && \
    echo "REWORKD_PLATFORM_ENVIRONMENT=$REWORKD_PLATFORM_ENVIRONMENT" >> .env && \
    echo "REWORKD_PLATFORM_FRONTEND_URL=$REWORKD_PLATFORM_FRONTEND_URL" >> .env && \
    echo "REWORKD_PLATFORM_SID_REDIRECT_URI=$REWORKD_PLATFORM_SID_REDIRECT_URI" >> .env

# Copying actual application
RUN poetry install --only main

CMD ["/usr/local/bin/python", "-m", "reworkd_platform", '--port', $PORT]

EXPOSE $PORT