# Use the official Node.js image as the base image
FROM node:20-alpine

ARG NODE_ENV
ENV NODE_ENV=$NODE_ENV
ARG NEXT_PUBLIC_VERCEL_ENV=${NODE_ENV}
ENV NEXT_PUBLIC_VERCEL_ENV=${NEXT_PUBLIC_VERCEL_ENV}
ARG NEXT_PUBLIC_BACKEND_URL
ENV NEXT_PUBLIC_BACKEND_URL=${NEXT_PUBLIC_BACKEND_URL}
ARG NEXT_PUBLIC_MAX_LOOPS
ENV NEXT_PUBLIC_MAX_LOOPS=${NEXT_PUBLIC_MAX_LOOPS}
ARG NEXTAUTH_SECRET
ENV NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
ARG NEXTAUTH_URL
ENV NEXTAUTH_URL=${NEXTAUTH_URL}

# Auth providers (Use if you want to get out of development mode sign-in):
ARG GOOGLE_CLIENT_ID
ENV GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
ARG GOOGLE_CLIENT_SECRET
ENV GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
ARG GITHUB_CLIENT_ID
ENV GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}
ARG GITHUB_CLIENT_SECRET
ENV GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}
ARG DISCORD_CLIENT_SECRET
ENV DISCORD_CLIENT_SECRET=${DISCORD_CLIENT_SECRET}
ARG DISCORD_CLIENT_ID
ENV DISCORD_CLIENT_ID=${DISCORD_CLIENT_ID}

# Database (Frontend):
ARG DATABASE_USER
ENV DATABASE_USER=${DATABASE_USER}
ARG DATABASE_PASSWORD
ENV DATABASE_PASSWORD=${DATABASE_PASSWORD}
ARG DATABASE_HOST
ENV DATABASE_HOST=${DATABASE_HOST}
ARG DATABASE_PORT
ENV DATABASE_PORT=${DATABASE_PORT}
ARG DATABASE_NAME
ENV DATABASE_NAME=${DATABASE_NAME}
ARG DATABASE_URL
ENV DATABASE_URL=${DATABASE_URL}

# Set the working directory
WORKDIR /app/next

# Copy package.json and package-lock.json to the working directory
COPY ./next /app/next

# Writing all environment variables into a .env file
RUN echo "NODE_ENV=$NODE_ENV" > .env && \
    echo "NEXT_PUBLIC_VERCEL_ENV=$NEXT_PUBLIC_VERCEL_ENV" >> .env && \
    echo "NEXT_PUBLIC_BACKEND_URL=$NEXT_PUBLIC_BACKEND_URL" >> .env && \
    echo "NEXT_PUBLIC_MAX_LOOPS=$NEXT_PUBLIC_MAX_LOOPS" >> .env && \
    echo "GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID" >> .env && \
    echo "GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET" >> .env && \
    echo "GITHUB_CLIENT_ID=$GITHUB_CLIENT_ID" >> .env && \
    echo "GITHUB_CLIENT_SECRET=$GITHUB_CLIENT_SECRET" >> .env && \
    echo "DISCORD_CLIENT_ID=$DISCORD_CLIENT_ID" >> .env && \
    echo "DATABASE_USER=$DATABASE_USER" >> .env && \
    echo "DATABASE_PASSWORD=$DATABASE_PASSWORD" >> .env && \
    echo "DATABASE_HOST=$DATABASE_HOST" >> .env && \
    echo "DATABASE_PORT=$DATABASE_PORT" >> .env && \
    echo "DATABASE_NAME=$DATABASE_NAME" >> .env && \
    echo "DATABASE_URL=$DATABASE_URL" >> .env

# Install dependencies
RUN npm ci && \
    npm run build

# Expose the port the app will run on
EXPOSE 3000

# Start the application
CMD ["npx", "next", "start"]
